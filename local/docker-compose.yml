## -- DO NOT EDIT THIS FILE --
##
## Edit '.env' for configuration.
##
## If '.env' does not exist, copy 'env-example' to '.env'
##   $ cp env-example .env
##

version: '3'

################################################################################
# SERVICES
################################################################################
services:

  # ------------------------------------------------------------
  # Web Server
  # ------------------------------------------------------------
  web:
    container_name: ${COMPOSE_PROJECT_NAME}_${WEB_SERVER_NAME}
    image: ${WEB_SERVER}

    environment:

      ##
      ## UserID and GroupID
      ##
      APACHE_USER_UID: ${NEW_UID}
      APACHE_USER_GID: ${NEW_GID}

      POSTFIX_myhostname: ${PROJECT_HOSTNAME}
      POSTFIX_mydestination: ${PROJECT_HOSTNAME}
      POSTFIX_relayhost: ${IP_MAILHOG_SERVICE}:1025

      XDEBUG_CONFIG: remote_host=${IP_LOCAL_COMPUTER}

    volumes:
      # ---- Format: ----
      # HOST-DIRECTORY : DOCKER-DIRECTORY

      # mount web folder
      - ${HOST_PATH_WEB_WWW}:/var/www/html/project
      - ${DEVBOX_PATH}/../:/var/www/html/docker

      # Website config
      - ${DEVBOX_PATH}/config/${WEB_SERVER_NAME}/sites-enabled/:/etc/apache2/sites-enabled/

      # composer config
      - ${DEVBOX_PATH}/config/composer/:/var/www/.composer/

      # ssh config
      - ${DEVBOX_PATH}/config/ssh/:/var/www/.ssh/

      # extra volume
      - ${HOST_PATH_WEB_EXTRA_STORAGE}:/mnt/

    working_dir: /var/www/html

    networks:
      app_net:
        ipv4_address: ${IP_WEB_SERVER}

    extra_hosts:
      - ${MYSQL_SERVER_NAME}-server:${IP_MYSQL_SERVER}
      - ${REDIS_SERVER_NAME}-server:${IP_REDIS_SERVER}
      - ${MAILHOG_SERVICE_NAME}-server:${IP_MAILHOG_SERVICE}

  # ------------------------------------------------------------
  # MySQL Database
  # ------------------------------------------------------------
  mysql:
    container_name: ${COMPOSE_PROJECT_NAME}_${MYSQL_SERVER_NAME}
    image: ${MYSQL_SERVER}

    environment:
      MYSQL_ROOT_PASSWORD: "docker"
      MYSQL_USER: "local"
      MYSQL_PASSWORD: "local"

    volumes:
      # ---- Format: ----
      # HOST-DIRECTORY : DOCKER-DIRECTORY
      - ${MYSQL_BACKUP_FOLDER}:/backup/

      - ${DEVBOX_PATH}:/devbox

    networks:
      app_net:
        ipv4_address: ${IP_MYSQL_SERVER}

  # ------------------------------------------------------------
  # Redis
  # ------------------------------------------------------------
  redis:
    container_name: ${COMPOSE_PROJECT_NAME}_${REDIS_SERVER_NAME}
    image: ${REDIS_SERVER}

    networks:
      app_net:
        ipv4_address: ${IP_REDIS_SERVER}

  # ------------------------------------------------------------
  # phpmyadmin
  # ------------------------------------------------------------
  phpmyadmin:
    container_name: ${COMPOSE_PROJECT_NAME}_${PHPMYADMIN_SERVICE_NAME}
    image: ${PHPMYADMIN_SERVICE}

    environment:
      PMA_HOST: ${IP_MYSQL_SERVER}
      PMA_USER: "root"
      PMA_PASSWORD: "docker"

    networks:
      app_net:
        ipv4_address: ${IP_PHPMYADMIN_SERVICE}

  # ------------------------------------------------------------
  # mailhog
  # ------------------------------------------------------------
  mailhog:
    container_name: ${COMPOSE_PROJECT_NAME}_${MAILHOG_SERVICE_NAME}
    image: ${MAILHOG_SERVICE}

    networks:
      app_net:
        ipv4_address: ${IP_MAILHOG_SERVICE}

  # ------------------------------------------------------------
  # npm
  # ------------------------------------------------------------
  npm:
    container_name: ${COMPOSE_PROJECT_NAME}_${NODE_SERVICE_NAME}
    image: ${NODE_SERVICE}

    volumes:
      # ---- Format: ----
      # HOST-DIRECTORY : DOCKER-DIRECTORY
      - ${HOST_PATH_NPM_DATADIR}:/data/
    working_dir: /data
    entrypoint: ['npm', '--no-bin-link']

    networks:
      app_net:
        ipv4_address: ${IP_NPM_SERVICE}

  # ------------------------------------------------------------
  # grunt
  # ------------------------------------------------------------
  grunt:
    container_name: ${COMPOSE_PROJECT_NAME}_${GRUNT_SERVICE_NAME}
    image: ${GRUNT_SERVICE}

    volumes:
      # ---- Format: ----
      # HOST-DIRECTORY : DOCKER-DIRECTORY
      - ${HOST_PATH_GRUNT_DATADIR}:/data/

    working_dir: /data
    entrypoint: ['grunt']

    networks:
      app_net:
        ipv4_address: ${IP_GRUNT_SERVICE}

################################################################################
# NETWORK
################################################################################
networks:
  app_net:
    driver: bridge
    driver_opts:
      com.docker.network.enable_ipv6: "false"
    ipam:
      driver: default
      config:
        - subnet: ${IP_SUBNET}